#!/bin/sh
# shellcheck disable=SC1091,SC3037,SC3043

readonly packageName='pbr'
readonly __OK__='\033[0;32m[\xe2\x9c\x93]\033[0m'

# Transition from vpn-policy-routing
if [ -s '/etc/config/vpn-policy-routing' ] && [ ! -s '/etc/config/pbr-opkg' ]; then
	echo "Migrating vpn-policy-routing config file."
	mv '/etc/config/pbr' '/etc/config/pbr-opkg'
	sed 's/vpn-policy-routing/pbr/g' /etc/config/vpn-policy-routing > /etc/config/pbr
	uci set vpn-policy-routing.config.enabled=0; uci commit vpn-policy-routing;
fi

# Transition from older versions of pbr
sed -i 's/resolver_ipset/resolver_set/g' /etc/config/pbr
sed -i 's/iptables_rule_option/rule_create_option/g' /etc/config/pbr
sed -i "s/'FORWARD'/'forward'/g" /etc/config/pbr
sed -i "s/'INPUT'/'input'/g" /etc/config/pbr
sed -i "s/'OUTPUT'/'output'/g" /etc/config/pbr
sed -i "s/'PREROUTING'/'prerouting'/g" /etc/config/pbr
sed -i "s/'POSTROUTING'/'postrouting'/g" /etc/config/pbr
sed -i "s/option fw_mask '0x\(.*\)'/option fw_mask '\1'/g" /etc/config/pbr
sed -i "s/option wan_mark '0x\(.*\)'/option wan_mark '\1'/g" /etc/config/pbr

uci -q batch <<-EOT
	delete firewall.pbr
	set firewall.pbr='include'
	set firewall.pbr.fw4_compatible='1'
	set firewall.pbr.type='script'
	set firewall.pbr.path='/usr/share/pbr/pbr.firewall.include'
	commit firewall
EOT

pbr_iface_setup() {
	local iface="${1}"
	local proto
	config_get proto "${iface}" proto
	case "${iface}" in
		(lan|loopback) return 0 ;;
	esac
	case "${proto}" in
		(gre*|nebula|relay|vti*|vxlan|xfrm) return 0 ;;
		(none)
			uci -q set "network.${iface}_rt=route"
			uci -q set "network.${iface}_rt.interface=${iface}"
			uci -q set "network.${iface}_rt.target=0.0.0.0/0"
			uci -q set "network.${iface}_rt6=route6"
			uci -q set "network.${iface}_rt6.interface=${iface}"
			uci -q set "network.${iface}_rt6.target=::/0"
		;;
	esac
	echo -en "Setting up ${packageName} routing tables for ${iface}... "
	uci -q set "network.${iface}.ip4table=${packageName}_${iface%6}"
	uci -q set "network.${iface}.ip6table=${packageName}_${iface%6}"
	if ! grep -q -E -e "^[0-9]+\s+${packageName}_${iface%6}$" /etc/iproute2/rt_tables; then
		sed -i -e "\$a $(($(sort -r -n /etc/iproute2/rt_tables | grep -o -E -m 1 "^[0-9]+")+1))\t${packageName}_${iface%6}" \
			/etc/iproute2/rt_tables
	fi
	echo -e "${__OK__}"
}

if [ -s "/etc/.custom_revision" ]; then
. /lib/functions.sh
. /lib/functions/network.sh
config_load network
config_foreach pbr_iface_setup interface
network_flush_cache
network_find_wan iface
network_find_wan6 iface6
# shellcheck disable=SC2154
[ -n "$iface" ] && uci -q batch << EOF
set network.default='rule'
set network.default.lookup='${packageName}_${iface%6}'
set network.default.priority='80000'
EOF
[ -n "$iface6" ] && uci -q batch << EOF
set network.default6='rule6'
set network.default6.lookup='${packageName}_${iface6%6}'
set network.default6.priority='80000'
EOF
uci commit network
echo -en "Restarting network... "
/etc/init.d/network restart
echo -e "${__OK__}"
fi

exit 0
